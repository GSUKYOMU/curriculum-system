<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê°„í˜¸í•™ê³¼ ì…í•™ì êµìœ¡ê³¼ì •</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

  <div class="max-w-6xl mx-auto py-8 px-4">
    <a href="../index.html" class="text-blue-600 text-sm">&larr; ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    <h1 class="text-3xl font-bold mt-2 mb-4">ê°„í˜¸í•™ê³¼ ì…í•™ì êµìœ¡ê³¼ì •</h1>

    <!-- ê³¼ì • ì„ íƒ -->
    <div class="bg-white rounded-xl shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-3">ê³¼ì • ì„ íƒ</h2>
      <div id="trackButtons" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- ì…í•™ë…„ë„ ì„ íƒ ë° ë‹¤ìš´ë¡œë“œ -->
    <div class="bg-white rounded-xl shadow p-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-2">
        <h2 class="text-xl font-semibold">ì…í•™ë…„ë„ë³„ ìµœì¢… êµìœ¡ê³¼ì •</h2>
        <div id="yearButtons" class="flex flex-wrap gap-2 text-sm"></div>
      </div>

      <button onclick="downloadExcel()"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mb-4 text-sm">
        ğŸ“¥ í˜„ì¬ êµìœ¡ê³¼ì • ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
      </button>

      <div id="noData" class="text-gray-500 text-sm hidden">
        ì„ íƒí•œ ê³¼ì •/ì…í•™ë…„ë„ì— í•´ë‹¹í•˜ëŠ” êµìœ¡ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border" id="curriculumTable">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1">ê°œì„¤í•™ë…„</th>
              <th class="border px-2 py-1">ê°œì„¤í•™ê¸°</th>
              <th class="border px-2 py-1">êµê³¼ëª©ëª…</th>
              <th class="border px-2 py-1">í•™ì </th>
              <th class="border px-2 py-1">ì´ì‹œìˆ˜</th>
              <th class="border px-2 py-1">ì´ë¡ </th>
              <th class="border px-2 py-1">ì‹¤ìŠµ</th>
              <th class="border px-2 py-1">ì‹¤í—˜</th>
              <th class="border px-2 py-1">ì‹¤ê¸°</th>
              <th class="border px-2 py-1">ë¹„ê³ </th>
            </tr>
          </thead>
          <tbody id="curriculumBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ë³€ê²½ë‚´ì—­ íŒ¨ë„ -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden"></div>
  <div id="changePanel" class="fixed top-0 right-0 h-full w-full md:w-1/3 bg-white shadow-xl transform translate-x-full transition-transform duration-200">
    <div class="p-4 border-b flex items-center justify-between">
      <h3 class="text-lg font-semibold">ë³€ê²½ ë‚´ì—­</h3>
      <button onclick="closeChangePanel()" class="text-sm text-gray-500">ë‹«ê¸°</button>
    </div>
    <div id="changeContent" class="p-4 text-sm overflow-y-auto"></div>
  </div>


<script>
const PARENT_DEPT = "ê°„í˜¸í•™ê³¼";
const TRACKS = ["ê°„í˜¸í•™ê³¼"];
const STORAGE_KEY = "curriculumData";

let selectedTrack = TRACKS[0];
let selectedYear = null;
let currentEntries = [];
let currentEntry = null;

// LocalStorage ê°€ì ¸ì˜¤ê¸°
function getData() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
  catch (e) { return []; }
}

// ê³¼ì • ë²„íŠ¼ ìƒì„±
function initTrackButtons() {
  const c = document.getElementById("trackButtons");
  c.innerHTML = "";
  TRACKS.forEach(track => {
    const btn = document.createElement("button");
    btn.textContent = track;
    btn.className =
      "px-3 py-1 rounded-full border text-sm " +
      (track === selectedTrack ? "bg-blue-600 text-white" : "bg-white text-gray-700");

    btn.onclick = () => {
      selectedTrack = track;
      selectedYear = null;
      loadEntries();
      initTrackButtons();
    };
    c.appendChild(btn);
  });
}

// ì—°ë„ë³„ ë°ì´í„° ë¡œë“œ
function loadEntries() {
  const all = getData();
  const filtered = all.filter(d => d.dept === selectedTrack);

  const map = {};
  filtered.forEach(e => {
    if (!map[e.year] || map[e.year].uploadDate < e.uploadDate) {
      map[e.year] = e;
    }
  });

  currentEntries = Object.values(map).sort((a, b) => a.year.localeCompare(b.year));
  renderYearButtons();
}

// ì—°ë„ ë²„íŠ¼ ìƒì„±
function renderYearButtons() {
  const c = document.getElementById("yearButtons");
  c.innerHTML = "";

  if (currentEntries.length === 0) {
    document.getElementById("noData").classList.remove("hidden");
    return;
  }

  document.getElementById("noData").classList.add("hidden");

  if (!selectedYear) selectedYear = currentEntries[0].year;

  currentEntries.forEach(e => {
    const btn = document.createElement("button");
    btn.textContent = e.year + " ì…í•™ì";
    btn.className =
      "px-3 py-1 rounded-full border " +
      (e.year === selectedYear ? "bg-indigo-600 text-white" : "bg-white text-gray-700");

    const hasChanges = e.changes && e.changes.length > 0;
    if (hasChanges) {
      const mark = document.createElement("span");
      mark.textContent = "ë³€ê²½ ìˆìŒ";
      mark.className = "text-red-500 text-xs ml-1";
      btn.appendChild(mark);
    }

    btn.onclick = () => {
      selectedYear = e.year;
      renderYearButtons();
    };

    c.appendChild(btn);
  });

  renderCurriculum();
}

// êµìœ¡ê³¼ì • í‘œ ë Œë”ë§
function renderCurriculum() {
  currentEntry = currentEntries.find(e => e.year === selectedYear);
  const tbody = document.getElementById("curriculumBody");
  tbody.innerHTML = "";

  if (!currentEntry) return;

  const changes = currentEntry.changes || [];
  const changeMap = {};

  changes.forEach(c => {
    if (!changeMap[c.subject]) changeMap[c.subject] = [];
    changeMap[c.subject].push(c);
  });

  (currentEntry.data || []).forEach(row => {
    const tr = document.createElement("tr");
    const subject = row["êµê³¼ëª©ëª…"];
    const changed = !!changeMap[subject];

    const cells = [
      row["ê°œì„¤í•™ë…„"], row["ê°œì„¤í•™ê¸°"], subject, row["í•™ì "], row["ì´ì‹œìˆ˜"],
      row["ì´ë¡ ì‹œìˆ˜"], row["ì‹¤ìŠµì‹œìˆ˜"], row["ì‹¤í—˜ì‹œìˆ˜"], row["ì‹¤ê¸°ì‹œìˆ˜"], row["ë¹„ê³ "]
    ];

    cells.forEach((v, idx) => {
      const td = document.createElement("td");
      td.className = "border px-2 py-1 whitespace-nowrap";

      if (idx === 2 && changed) {
        td.innerHTML =
          `<button class="bg-yellow-100 border border-yellow-300 text-yellow-800 text-xs px-2 py-0.5 rounded-full"
            onclick="openChangePanel('${subject}')">${subject} ë³€ê²½ë‚´ì—­</button>`;
      } else {
        td.textContent = v || "";
      }

      tr.appendChild(td);
    });

    if (changed) tr.classList.add("bg-yellow-50");
    tbody.appendChild(tr);
  });
}

// ë³€ê²½ íŒ¨ë„ ì—´ê¸°
function openChangePanel(subject) {
  const entry = currentEntry.changes.filter(c => c.subject === subject);
  const panel = document.getElementById("changePanel");
  const overlay = document.getElementById("overlay");
  const content = document.getElementById("changeContent");

  content.innerHTML = `<h4 class="font-semibold mb-3">êµê³¼ëª©: ${subject}</h4>`;

  entry.forEach(ch => {
    let html = "";

    if (ch.type === "ì¶”ê°€ë¨") {
      html += `<p class="text-green-700 mb-2">ìƒˆë¡œ ì¶”ê°€ëœ ê³¼ëª©ì…ë‹ˆë‹¤.</p>`;
    } else if (ch.type === "ì‚­ì œë¨") {
      html += `<p class="text-red-700 mb-2">ì´ì „ ë²„ì „ì—ì„œ ì‚­ì œëœ ê³¼ëª©ì…ë‹ˆë‹¤.</p>`;
    } else if (ch.type === "ë³€ê²½ë¨") {
      html += `<table class="text-xs w-full border mb-3">
        <thead><tr class="bg-gray-100">
          <th class="border px-1">í•­ëª©</th>
          <th class="border px-1">ë³€ê²½ ì „</th>
          <th class="border px-1">ë³€ê²½ í›„</th>
        </tr></thead>
        <tbody>`;

      Object.keys(ch.detail).forEach(k => {
        html += `<tr>
          <td class="border px-1">${k}</td>
          <td class="border px-1">${ch.detail[k].before || ""}</td>
          <td class="border px-1">${ch.detail[k].after || ""}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
    }

    content.innerHTML += html + "<hr class='my-2'>";
  });

  overlay.classList.remove("hidden");
  panel.classList.remove("translate-x-full");
  overlay.onclick = closeChangePanel;
}

// ë³€ê²½ íŒ¨ë„ ë‹«ê¸°
function closeChangePanel() {
  document.getElementById("overlay").classList.add("hidden");
  document.getElementById("changePanel").classList.add("translate-x-full");
}

// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function downloadExcel() {
  if (!currentEntry) {
    alert("ë‹¤ìš´ë¡œë“œí•  êµìœ¡ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const wb = XLSX.utils.book_new();

  const rows = [
    ["í•™ê³¼ëª…", currentEntry.dept],
    ["ì…í•™ë…„ë„", currentEntry.year],
    ["ë¬¸ì„œë²ˆí˜¸", currentEntry.docNum],
    ["ìˆ˜ì •ë¬¸ì„œë²ˆí˜¸", currentEntry.revDocNum || ""],
    ["êµìœ¡ê³¼ì •ìœ„ì›íšŒ í™•ì •ì—¬ë¶€", currentEntry.approved ? "í™•ì •" : "ë¯¸í™•ì •"],
    ["êµìœ¡ê³¼ì •ìœ„ì›íšŒ ê°œìµœì¼", current
