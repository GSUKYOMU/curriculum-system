<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê°„í˜¸í•™ê³¼ ì…í•™ì êµìœ¡ê³¼ì •</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <style>
    /* í…Œì´ë¸” ê°•ì¡° ìƒ‰ìƒ */
    .changed-row {
      background-color: #fff8dc !important;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

  <div class="max-w-6xl mx-auto py-8 px-4">
    <a href="../index.html" class="text-blue-600 text-sm">&larr; ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    <h1 class="text-3xl font-bold mt-2 mb-4">ê°„í˜¸í•™ê³¼ ì…í•™ì êµìœ¡ê³¼ì •</h1>

    <!-- ê³¼ì • ì„ íƒ -->
    <div class="bg-white rounded-xl shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-3">ê³¼ì • ì„ íƒ</h2>
      <div id="trackButtons" class="flex flex-wrap gap-2"></div>
    </div>
    <!-- ì…í•™ë…„ë„ ì„ íƒ ë° ë‹¤ìš´ë¡œë“œ -->
    <div class="bg-white rounded-xl shadow p-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-2">
        <h2 class="text-xl font-semibold">ì…í•™ë…„ë„ë³„ ìµœì¢… êµìœ¡ê³¼ì •</h2>
        <div id="yearButtons" class="flex flex-wrap gap-2 text-sm"></div>
      </div>

      <button onclick="downloadExcel()"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mb-4 text-sm">
        ğŸ“¥ í˜„ì¬ êµìœ¡ê³¼ì • ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
      </button>

      <div id="noData" class="text-gray-500 text-sm hidden">
        ì„ íƒí•œ ê³¼ì • / ì…í•™ë…„ë„ì— í•´ë‹¹í•˜ëŠ” êµìœ¡ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border" id="curriculumTable">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(0)">ê°œì„¤í•™ë…„</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(1)">ê°œì„¤í•™ê¸°</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(2)">êµê³¼ëª©ëª…</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(3)">í•™ì </th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(4)">ì´ì‹œìˆ˜</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(5)">ì´ë¡ </th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(6)">ì‹¤ìŠµ</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(7)">ì‹¤í—˜</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(8)">ì‹¤ê¸°</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(9)">ë¹„ê³ </th>
            </tr>
          </thead>
          <tbody id="curriculumBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ë³€ê²½ë‚´ì—­ íŒ¨ë„ -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden"></div>
  <div id="changePanel"
       class="fixed top-0 right-0 h-full w-full md:w-1/3 bg-white shadow-xl transform translate-x-full transition-transform duration-200">
    <div class="p-4 border-b flex items-center justify-between">
      <h3 class="text-lg font-semibold">ë³€ê²½ ë‚´ì—­</h3>
      <button onclick="closeChangePanel()" class="text-sm text-gray-500">ë‹«ê¸°</button>
    </div>
    <div id="changeContent" class="p-4 text-sm overflow-y-auto"></div>
  </div>
<script>
/* -------------------------
    ê¸°ë³¸ ì„¤ì •
-------------------------- */
const PARENT_DEPT = "ê°„í˜¸í•™ê³¼";
const TRACKS = ["ê°„í˜¸í•™ê³¼"];
const STORAGE_KEY = "curriculumData";

let selectedTrack = TRACKS[0];
let selectedYear = null;
let currentEntries = [];
let currentEntry = null;
let sortState = {};  // ì •ë ¬ ìƒíƒœ ì €ì¥

/* ---------------------------------------------------
   ìœ ë‹ˆì½”ë“œ ì •ê·œí™” + ê³µë°± ì •ë¦¬ + ë¬¸ìì—´ ë¹„êµ í†µì¼
--------------------------------------------------- */
function clean(v) {
  return (v || "")
    .toString()
    .normalize("NFKC")           // â… (ë¡œë§ˆìˆ«ì) vs I(ì˜ë¬¸ ëŒ€ë¬¸ì) ê°™ì€ ë¬¸ì œ í•´ê²°
    .replace(/\s+/g, " ")        // ê³µë°± ì—¬ëŸ¬ê°œ â†’ í•œ ê°œ
    .replace(/ /g, " ")          // íŠ¹ìˆ˜ ê³µë°± ì œê±°
    .trim();
}

function same(a, b) {
  return clean(a) === clean(b);
}

/* -------------------------
    ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
-------------------------- */
function getData() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  } catch (e) {
    return [];
  }
}

function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
/* -------------------------
    ê³¼ì • ì„ íƒ ë²„íŠ¼ ìƒì„±
-------------------------- */
function initTrackButtons() {
  const c = document.getElementById("trackButtons");
  c.innerHTML = "";

  TRACKS.forEach(track => {
    const btn = document.createElement("button");
    btn.textContent = track;
    btn.className =
      "px-3 py-1 rounded-full border text-sm " +
      (track === selectedTrack ? "bg-blue-600 text-white" : "bg-white text-gray-700");

    btn.onclick = () => {
      selectedTrack = track;
      selectedYear = null;
      loadEntries();
      initTrackButtons();
    };

    c.appendChild(btn);
  });
}

/* -------------------------
    í•™ê³¼ ë°ì´í„° ë¡œë”©
-------------------------- */
function loadEntries() {
  const all = getData();
  const filtered = all.filter(d => same(d.dept, selectedTrack));

  const map = {};
  filtered.forEach(e => {
    // ë™ì¼ ì—°ë„ì—ì„œ ê°€ì¥ ìµœê·¼ uploadDateë§Œ ì„ íƒ
    if (!map[e.year] || new Date(map[e.year].uploadDate) < new Date(e.uploadDate)) {
      map[e.year] = e;
    }
  });

  currentEntries = Object.values(map).sort((a, b) => clean(a.year).localeCompare(clean(b.year)));
  renderYearButtons();
}

/* -------------------------
    ì…í•™ë…„ë„ ë²„íŠ¼ ë Œë”ë§
-------------------------- */
function renderYearButtons() {
  const c = document.getElementById("yearButtons");
  c.innerHTML = "";

  if (currentEntries.length === 0) {
    document.getElementById("noData").classList.remove("hidden");
    return;
  }

  document.getElementById("noData").classList.add("hidden");
  if (!selectedYear) selectedYear = currentEntries[0].year;

  currentEntries.forEach(e => {
    const btn = document.createElement("button");
    btn.textContent = `${e.year} ì…í•™ì`;
    btn.className =
      "px-3 py-1 rounded-full border text-sm " +
      (e.year === selectedYear ? "bg-indigo-600 text-white" : "bg-white text-gray-700");

    // ë³€ê²½ë‚´ì—­ ì¡´ì¬ ì—¬ë¶€ í‘œì‹œ
    if (e.changes && e.changes.length > 0) {
      const mark = document.createElement("span");
      mark.textContent = "ë³€ê²½ ìˆìŒ";
      mark.className = "text-red-500 text-xs ml-1";
      btn.appendChild(mark);
    }

    btn.onclick = () => {
      selectedYear = e.year;
      renderYearButtons();
    };

    c.appendChild(btn);
  });

  renderCurriculum();
}
/* -------------------------
    êµìœ¡ê³¼ì • í…Œì´ë¸” ì¶œë ¥
-------------------------- */
function renderCurriculum() {
  currentEntry = currentEntries.find(e => same(e.year, selectedYear));
  const tbody = document.getElementById("curriculumBody");
  tbody.innerHTML = "";

  if (!currentEntry) return;

  const changes = currentEntry.changes || [];
  const changeMap = {};

  // ë³€ê²½ë‚´ì—­ ì •ê·œí™”í•˜ì—¬ ë§¤í•‘
  changes.forEach(c => {
    const subjectKey = clean(c.subject || c.afterName || c.beforeName);
    if (!subjectKey) return;

    if (!changeMap[subjectKey]) changeMap[subjectKey] = [];
    changeMap[subjectKey].push(c);
  });

  // êµìœ¡ê³¼ì • í–‰ ì¶œë ¥
  (currentEntry.data || []).forEach(row => {
    const tr = document.createElement("tr");

    const subjectRaw = row["êµê³¼ëª©ëª…"] || "";
    const subjectClean = clean(subjectRaw);

    const changed = !!changeMap[subjectClean];

    const cells = [
      row["ê°œì„¤í•™ë…„"], row["ê°œì„¤í•™ê¸°"], subjectRaw,
      row["í•™ì "], row["ì´ì‹œìˆ˜"], row["ì´ë¡ ì‹œìˆ˜"],
      row["ì‹¤ìŠµì‹œìˆ˜"], row["ì‹¤í—˜ì‹œìˆ˜"], row["ì‹¤ê¸°ì‹œìˆ˜"],
      row["ë¹„ê³ "]
    ];

    cells.forEach((v, idx) => {
      const td = document.createElement("td");
      td.className = "border px-2 py-1 whitespace-nowrap";

      if (idx === 2 && changed) {
        // ë³€ê²½ ë²„íŠ¼
        td.innerHTML = `
          <button
            class="bg-yellow-100 border border-yellow-300 text-yellow-800 text-xs px-2 py-0.5 rounded-full"
            onclick="openChangePanel('${subjectClean.replace(/'/g, "\\'")}')"
          >
            ${v} ë³€ê²½ë‚´ì—­
          </button>
        `;
      } else {
        td.textContent = v || "";
      }

      tr.appendChild(td);
    });

    if (changed) tr.classList.add("bg-yellow-50");
    tbody.appendChild(tr);
  });
}
