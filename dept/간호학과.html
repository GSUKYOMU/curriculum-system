<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>간호학과 입학자 교육과정</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

  <div class="max-w-6xl mx-auto py-8 px-4">
    <a href="../index.html" class="text-blue-600 text-sm">&larr; 메인으로 돌아가기</a>
    <h1 class="text-3xl font-bold mt-2 mb-4">간호학과 입학자 교육과정</h1>

        <div class="bg-white rounded-xl shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-3">과정 선택</h2>
      <div id="trackButtons" class="flex flex-wrap gap-2"></div>
    </div>

        <div class="bg-white rounded-xl shadow p-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-2">
        <h2 class="text-xl font-semibold">입학년도별 최종 교육과정</h2>
        <div id="yearButtons" class="flex flex-wrap gap-2 text-sm"></div>
      </div>

      <button onclick="downloadExcel()"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mb-4 text-sm">
        📥 현재 교육과정 엑셀 다운로드
      </button>

      <div id="noData" class="text-gray-500 text-sm hidden">
        선택한 과정 / 입학년도에 해당하는 교육과정이 없습니다.
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border" id="curriculumTable">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(0)">개설학년</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(1)">개설학기</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(2)">교과목명</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(3)">학점</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(4)">총시수</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(5)">이론</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(6)">실습</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(7)">실험</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(8)">실기</th>
              <th class="border px-2 py-1 cursor-pointer" onclick="sortTable(9)">비고</th>
            </tr>
          </thead>
          <tbody id="curriculumBody"></tbody>
        </table>
      </div>
    </div>
  </div>

    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden"></div>
  <div id="changePanel"
       class="fixed top-0 right-0 h-full w-full md:w-1/3 bg-white shadow-xl transform translate-x-full transition-transform duration-200">
    <div class="p-4 border-b flex items-center justify-between">
      <h3 class="text-lg font-semibold">변경 내역</h3>
      <button onclick="closeChangePanel()" class="text-sm text-gray-500">닫기</button>
    </div>
    <div id="changeContent" class="p-4 text-sm overflow-y-auto"></div>
  </div>

<script>
/* -------------------------
    기본 설정
-------------------------- */
const PARENT_DEPT = "간호학과";
const TRACKS = ["간호학과"];
const STORAGE_KEY = "curriculumData";

let selectedTrack = TRACKS[0];
let selectedYear = null;
let currentEntries = [];
let currentEntry = null;
let sortState = {};  // 정렬 상태 저장

function getData() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
  catch (e) { return []; }
}

/* -------------------------
    과정 선택 버튼
-------------------------- */
function initTrackButtons() {
  const c = document.getElementById("trackButtons");
  c.innerHTML = "";

  TRACKS.forEach(track => {
    const btn = document.createElement("button");
    btn.textContent = track;
    btn.className =
      "px-3 py-1 rounded-full border text-sm " +
      (track === selectedTrack ? "bg-blue-600 text-white" : "bg-white text-gray-700");

    btn.onclick = () => {
      selectedTrack = track;
      selectedYear = null;
      loadEntries();
      initTrackButtons();
    };
    c.appendChild(btn);
  });
}

/* -------------------------
    학과 데이터 로딩
-------------------------- */
function loadEntries() {
  const all = getData();
  const filtered = all.filter(d => d.dept === selectedTrack);

  const map = {};
  filtered.forEach(e => {
    if (!map[e.year] || map[e.year].uploadDate < e.uploadDate) {
      map[e.year] = e;
    }
  });

  currentEntries = Object.values(map).sort((a, b) => a.year.localeCompare(b.year));
  renderYearButtons();
}

/* -------------------------
    입학년도 버튼
-------------------------- */
function renderYearButtons() {
  const c = document.getElementById("yearButtons");
  c.innerHTML = "";

  if (currentEntries.length === 0) {
    document.getElementById("noData").classList.remove("hidden");
    return;
  }

  document.getElementById("noData").classList.add("hidden");

  if (!selectedYear) selectedYear = currentEntries[0].year;

  currentEntries.forEach(e => {
    const btn = document.createElement("button");
    btn.textContent = e.year + " 입학자";
    btn.className =
      "px-3 py-1 rounded-full border text-sm " +
      (e.year === selectedYear ? "bg-indigo-600 text-white" : "bg-white text-gray-700");

    if (e.changes && e.changes.length > 0) {
      const mark = document.createElement("span");
      mark.textContent = "변경 있음";
      mark.className = "text-red-500 text-xs ml-1";
      btn.appendChild(mark);
    }

    btn.onclick = () => {
      selectedYear = e.year;
      renderYearButtons();
    };

    c.appendChild(btn);
  });

  renderCurriculum();
}

/* -------------------------
    교육과정 테이블 출력 (수정됨)
-------------------------- */
function renderCurriculum() {
  currentEntry = currentEntries.find(e => e.year === selectedYear);
  const tbody = document.getElementById("curriculumBody");
  tbody.innerHTML = "";

  if (!currentEntry || !currentEntry.data) return;

  const changes = currentEntry.changes || [];
  const changeMap = {};

  // 변경된 과목을 교과목명 기준으로 맵에 저장
  changes.forEach(c => {
    // 추가/삭제뿐만 아니라, 변경(학점, 시수 등)이 있는 과목도 여기에 포함됨
    if (!changeMap[c.subject]) changeMap[c.subject] = [];
    changeMap[c.subject].push(c);
  });

  (currentEntry.data || []).forEach(row => {
    const tr = document.createElement("tr");
    const subject = row["교과목명"];
    // 해당 교과목에 변경 내역이 있는지 확인
    const changed = !!changeMap[subject];

    const cells = [
      row["개설학년"], row["개설학기"], subject, row["학점"], row["총시수"],
      row["이론시수"], row["실습시수"], row["실험시수"], row["실기시수"], row["비고"]
    ];

    cells.forEach((v, idx) => {
      const td = document.createElement("td");
      td.className = "border px-2 py-1 whitespace-nowrap";

      // 교과목명 셀(idx === 2)이고 변경 사항이 있을 경우 버튼을 표시
      if (idx === 2 && changed) {
        td.innerHTML =
          `<button class="bg-yellow-100 border border-yellow-300 text-yellow-800 text-xs px-2 py-0.5 rounded-full"
            onclick="openChangePanel('${subject}')">${subject} 변경내역</button>`;
      } else {
        td.textContent = v || "";
      }

      tr.appendChild(td);
    });

    // 변경된 과목 전체 행에 노란색 배경 적용
    if (changed) tr.classList.add("bg-yellow-50");
    tbody.appendChild(tr);
  });
}

/* -------------------------
    정렬 기능
-------------------------- */
function sortTable(colIndex) {
  if (!currentEntry || !currentEntry.data) return;

  const current = sortState[colIndex] || "asc";
  const next = current === "asc" ? "desc" : "asc";
  sortState[colIndex] = next;

  const keys = [
    "개설학년","개설학기","교과목명","학점","총시수",
    "이론시수","실습시수","실험시수","실기시수","비고"
  ];

  const key = keys[colIndex];

  currentEntry.data.sort((a, b) => {
    let v1 = a[key] ?? "";
    let v2 = b[key] ?? "";

    const num1 = parseFloat(v1);
    const num2 = parseFloat(v2);

    if (!isNaN(num1) && !isNaN(num2)) {
      return next === "asc" ? num1 - num2 : num2 - num1;
    }

    v1 = v1.toString();
    v2 = v2.toString();
    return next === "asc"
      ? v1.localeCompare(v2)
      : v2.localeCompare(v1);
  });

  renderCurriculum();
}

/* -------------------------
    변경내역 패널
-------------------------- */
function openChangePanel(subject) {
  // subject가 changeMap의 키로 존재하며, 현재 보여지고 있는 교육과정에 포함된 변경 내역만 필터링
  const entries = currentEntry.changes.filter(c => c.subject === subject);
  const content = document.getElementById("changeContent");

  content.innerHTML = `<h4 class="font-semibold mb-3">교과목: ${subject}</h4>`;

  entries.forEach(ch => {
    // 변경 종류 라벨
    let typeLabel = "";
    if (ch.type === "추가" || ch.type === "추가됨") {
      typeLabel = `<p class="text-green-700 font-semibold mb-2">🆕 신규 개설</p>`;
    } else if (ch.type === "삭제됨") {
      typeLabel = `<p class="text-red-700 font-semibold mb-2">❌ 삭제됨</p>`;
    } else if (ch.type === "변경" || ch.type === "변경됨") {
      typeLabel = `<p class="text-amber-700 font-semibold mb-2">✏️ 내용 변경</p>`;
    }

    // 상세 변경 테이블 생성
    let detailHTML = "";
    if (ch.detail && Object.keys(ch.detail).length > 0) {
      detailHTML += `
        <table class="text-xs w-full border mb-3">
          <thead>
            <tr class="bg-gray-100">
              <th class="border px-1 py-0.5">항목</th>
              <th class="border px-1 py-0.5">변경 전</th>
              <th class="border px-1 py-0.5">변경 후</th>
            </tr>
          </thead>
          <tbody>
      `;
      Object.keys(ch.detail).forEach(k => {
        detailHTML += `
          <tr>
            <td class="border px-1 py-0.5">${k}</td>
            <td class="border px-1 py-0.5">${ch.detail[k].before || ""}</td>
            <td class="border px-1 py-0.5">${ch.detail[k].after || ""}</td>
          </tr>
        `;
      });
      detailHTML += `</tbody></table>`;
    }

    // 출력
    content.innerHTML += `
      <div class="mb-4 pb-4 border-b">
        ${typeLabel}

        ${detailHTML}

        <p class="text-xs text-gray-600 mt-2">📄 변경사유:</p>
        <p class="text-xs mb-2">${ch.reason || "사유 미작성"}</p>

        <p class="text-xs text-gray-500">문서번호: ${ch.changeDocNum || "-"}</p>
        <p class="text-xs text-gray-500">회의일: ${ch.changeDate || "-"}</p>
      </div>
    `;
  });

  document.getElementById("overlay").classList.remove("hidden");
  document.getElementById("changePanel").classList.remove("translate-x-full");
  document.getElementById("overlay").onclick = closeChangePanel;
}

function closeChangePanel() {
  document.getElementById("overlay").classList.add("hidden");
  document.getElementById("changePanel").classList.add("translate-x-full");
}

/* -------------------------
    엑셀 다운로드
-------------------------- */
function downloadExcel() {
  if (!currentEntry) {
    alert("다운로드할 교육과정이 없습니다.");
    return;
  }

  const wb = XLSX.utils.book_new();

  const rows = [
    ["학과명", currentEntry.dept],
    ["입학년도", currentEntry.year],
    ["문서번호", currentEntry.docNum],
    ["수정문서번호", currentEntry.revDocNum || ""],
    ["교육과정위원회 확정여부", currentEntry.approved ? "확정" : "미확정"],
    ["교육과정위원회 개최일", currentEntry.meetingDate || ""],
    [],
    [
      "개설학년","개설학기","교과목명","수준","이수구분",
      "학점","총시수","이론시수","실습시수","실험시수","실기시수","비고"
    ]
  ];

  (currentEntry.data || []).forEach(r => {
    rows.push([
      r["개설학년"], r["개설학기"], r["교과목명"], r["수준"], r["이수구분"],
      r["학점"], r["총시수"], r["이론시수"], r["실습시수"], r["실험시수"], r["실기시수"], r["비고"]
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "교육과정");

  const filename = `${currentEntry.dept}_${currentEntry.year}_입학자교육과정.xlsx`;
  XLSX.writeFile(wb, filename);
}

/* -------------------------
    초기 로딩
-------------------------- */
document.addEventListener("DOMContentLoaded", () => {
  initTrackButtons();
  loadEntries();
});
</script>

</body>
</html>
