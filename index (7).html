<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì…í•™ì êµìœ¡ê³¼ì • ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body class='p-6 bg-gray-100'>

<h1 class='text-3xl font-bold mb-4 text-center'>ì…í•™ì êµìœ¡ê³¼ì • ì—…ë¡œë“œ</h1>

<div class='bg-white p-4 rounded shadow max-w-3xl mx-auto'>
  <a href="./ì…í•™ìêµìœ¡ê³¼ì • ì—…ë¡œë“œ í…œí”Œë¦¿.xlsx" download class='px-3 py-2 bg-green-600 text-white rounded'>ğŸ“¥ ì—…ë¡œë“œ í…œí”Œë¦¿</a>
  <a href="./ì…í•™ìêµìœ¡ê³¼ì • ë³€ê²½ì‚¬ìœ ì„œ.xlsx" download class='px-3 py-2 bg-amber-600 text-white rounded'>ğŸ“¥ ë³€ê²½ì‚¬ìœ ì„œ</a>

  <input id="fileInput" type="file" class='border p-2 rounded w-full mt-4'>
  <button onclick="handleUpload()" class='mt-2 px-4 py-2 bg-blue-600 text-white rounded'>ì—…ë¡œë“œ</button>
</div>

<div class='bg-white p-4 rounded shadow max-w-3xl mx-auto mt-6'>
  <h2 class='text-xl font-bold mb-2'>í•™ê³¼ë³„ êµìœ¡ê³¼ì • ë³´ê¸°</h2>
  <ul id="deptList"></ul>
</div>

<div class='bg-white p-4 rounded shadow max-w-3xl mx-auto mt-6'>
  <h2 class='text-xl font-bold mb-2'>ì—…ë¡œë“œ ê¸°ë¡</h2>
  <table class='w-full text-sm border'>
    <thead><tr>
      <th class='border px-2 py-1'>ìœ í˜•</th>
      <th class='border px-2 py-1'>í•™ê³¼</th>
      <th class='border px-2 py-1'>ì…í•™ë…„ë„</th>
      <th class='border px-2 py-1'>ë¬¸ì„œë²ˆí˜¸</th>
      <th class='border px-2 py-1'>ë³€ê²½ê±´ìˆ˜</th>
      <th class='border px-2 py-1'>ì—…ë¡œë“œì¼</th>
      <th class='border px-2 py-1'>ë‹¤ìš´ë¡œë“œ</th>
      <th class='border px-2 py-1'>ì‚­ì œ</th>
    </tr></thead>
    <tbody id="uploadHistory"></tbody>
  </table>
</div>

<script>
const TOP_DEPTS=["ì‹ í•™ê³¼","ì‚¬íšŒë³µì§€í•™ê³¼","ìƒë‹´ì‹¬ë¦¬í•™ê³¼","G2ë¹…ë°ì´í„°ê²½ì˜í•™ê³¼","ì‹¤ìš©ìŒì•…í•™ê³¼","ê°„í˜¸í•™ê³¼","ì‹í’ˆì˜ì–‘í•™ê³¼","ì™¸êµ­ì¸ì „ë‹´í•™ê³¼"];
const STORAGE_KEY="curriculumData";
const HISTORY_KEY="uploadHistory";

function getData(){ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }
function saveData(v){ localStorage.setItem(STORAGE_KEY,JSON.stringify(v)); }
function getHistory(){ return JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]"); }
function saveHistory(v){ localStorage.setItem(HISTORY_KEY,JSON.stringify(v)); }

function handleUpload(){
  const f=document.getElementById("fileInput").files[0];
  if(!f){ alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”"); return; }
  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:"binary"});
    if(wb.Sheets["êµìœ¡ê³¼ì •"]) processCurriculum(wb.Sheets["êµìœ¡ê³¼ì •"],f.name);
    else if(wb.Sheets["ë³€ê²½ì‚¬ìœ ì„œ"]) processChange(wb.Sheets["ë³€ê²½ì‚¬ìœ ì„œ"],f.name);
    else alert("ì‹œíŠ¸ ì´ë¦„ ì˜¤ë¥˜: êµìœ¡ê³¼ì • ë˜ëŠ” ë³€ê²½ì‚¬ìœ ì„œ í•„ìš”");
  };
  r.readAsBinaryString(f);
}

function processCurriculum(sh,filename){
  const rows=XLSX.utils.sheet_to_json(sh,{header:1});
  const meta={
    dept:(rows[0][1]||"").trim(),
    year:(rows[1][1]||"").trim(),
    docNum:(rows[2][1]||"").trim()
  };
  let start=rows.findIndex(r=>r[0]==="ê°œì„¤í•™ë…„");
  const headers=rows[start];
  const data=rows.slice(start+1).filter(r=>r.length>0).map(r=>{
    const o={}; headers.forEach((h,i)=>o[h]=r[i]||""); return o;
  });
  let all=getData();
  all=all.filter(v=>!(v.dept===meta.dept&&v.year===meta.year&&v.docNum===meta.docNum));
  all.push({...meta,data,uploadDate:new Date().toISOString()});
  saveData(all);

  const hist=getHistory();
  hist.push({type:"ì „ì²´ ì—…ë¡œë“œ",...meta,changedCount:"-",uploadDate:new Date().toISOString()});
  saveHistory(hist);

  alert("ì—…ë¡œë“œ ì™„ë£Œ!");
  renderDeptList(); renderHistory();
}

function processChange(sh,filename){
  const rows=XLSX.utils.sheet_to_json(sh,{header:1});
  const dept=(rows[0][1]||"").trim();
  const docNum=(rows[3][1]||"").trim();
  let start=rows.findIndex(r=>r[0]==="(ë³€ê²½í• )êµìœ¡ê³¼ì • ì—°ë„");
  const dataRows=rows.slice(start+1).filter(r=>r.some(v=>v));
  let all=getData();
  let years=new Set(), applied=0;

  dataRows.forEach(r=>{
    const year=(r[0]||"").trim(); years.add(year);
    const next={
      grade:r[12],semester:r[13],type:r[14],name:r[15],
      credit:r[16],total:r[17],theory:r[18],practice:r[19],skill:r[20],experiment:r[21]
    };
    const entry=all.filter(v=>v.dept===dept&&v.year===year).sort((a,b)=>new Date(b.uploadDate)-new Date(a.uploadDate))[0];
    if(!entry) return;

    const idx=entry.data.findIndex(v=>v["êµê³¼ëª©ëª…"]===next.name);
    if(idx===-1){
      entry.data.push({
        "ê°œì„¤í•™ë…„":next.grade||"",
        "ê°œì„¤í•™ê¸°":next.semester||"",
        "ì´ìˆ˜êµ¬ë¶„":next.type||"",
        "êµê³¼ëª©ëª…":next.name||"",
        "í•™ì ":next.credit||"",
        "ì´ì‹œìˆ˜":next.total||"",
        "ì´ë¡ ì‹œìˆ˜":next.theory||"",
        "ì‹¤ìŠµì‹œìˆ˜":next.practice||"",
        "ì‹¤ê¸°ì‹œìˆ˜":next.skill||"",
        "ì‹¤í—˜ì‹œìˆ˜":next.experiment||""
      });
      applied++; return;
    }
  });

  saveData(all);
  const hist=getHistory();
  hist.push({type:"ë³€ê²½",dept,year:[...years].join(", "),docNum,changedCount:applied,uploadDate:new Date().toISOString()});
  saveHistory(hist);
  alert("ë³€ê²½ ì ìš© "+applied+"ê±´");
  renderHistory();
}

function renderDeptList(){
  const ul=document.getElementById("deptList");
  ul.innerHTML="";
  TOP_DEPTS.forEach(d=>ul.innerHTML+=`<li class='py-2'><a href="./dept/${d}.html" class='text-blue-600'>${d}</a></li>`);
}

function renderHistory(){
  const hist=getHistory();
  const tb=document.getElementById("uploadHistory");
  tb.innerHTML="";
  hist.forEach((h,i)=>{
    tb.innerHTML+=`
      <tr>
        <td class='border px-2 py-1'>${h.type}</td>
        <td class='border px-2 py-1'>${h.dept}</td>
        <td class='border px-2 py-1'>${h.year||"-"}</td>
        <td class='border px-2 py-1'>${h.docNum}</td>
        <td class='border px-2 py-1'>${h.changedCount}</td>
        <td class='border px-2 py-1'>${new Date(h.uploadDate).toLocaleString()}</td>
        <td class='border px-2 py-1'><button onclick='downloadHist(${i})' class='text-green-600'>ğŸ“¥</button></td>
        <td class='border px-2 py-1'><button onclick='delHist(${i})' class='text-red-600'>ğŸ—‘</button></td>
      </tr>`;
  });
}

function delHist(i){
  const h=getHistory(); h.splice(i,1); saveHistory(h); renderHistory();
}
function downloadHist(i){ alert("ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì€ ì¶”í›„ ì™„ì„± ì˜ˆì •!"); }

renderDeptList(); renderHistory();
</script>

</body></html>
