<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì…í•™ì êµìœ¡ê³¼ì • ê´€ë¦¬ ì‹œìŠ¤í…œ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">

  <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow">
    <h1 class="text-3xl font-bold mb-6 text-center">ì…í•™ì êµìœ¡ê³¼ì • ì—…ë¡œë“œ</h1>

    <!-- í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (Aì•ˆ: ì—…ë¡œë“œ ì…ë ¥ì°½ ìœ„ìª½) -->
    <a 
      href="./ì…í•™ìêµìœ¡ê³¼ì • ì—…ë¡œë“œ í…œí”Œë¦¿.xlsx"
      download
      class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 inline-block mb-4"
    >
      ğŸ“¥ ì…í•™ìêµìœ¡ê³¼ì • ì—…ë¡œë“œ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
    </a>

    <!-- íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="mb-6">
      <input id="fileInput" type="file" accept=".xlsx,.xls" class="border p-3 rounded w-full"/>
    </div>

    <button onclick="handleUpload()"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      ì—…ë¡œë“œ
    </button>
  </div>

  <div class="max-w-4xl mx-auto bg-white p-6 mt-8 rounded-xl shadow">
    <h2 class="text-2xl font-semibold mb-4">í•™ê³¼ë³„ êµìœ¡ê³¼ì • ë³´ê¸°</h2>
    <ul id="deptList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></ul>
  </div>

<script>
// ìƒìœ„ í•™ê³¼ ëª©ë¡ (í‘œì‹œ ìˆœì„œ ê³ ì •)
const TOP_DEPTS = [
  "ì‹ í•™ê³¼",
  "ì‚¬íšŒë³µì§€í•™ê³¼",
  "ìƒë‹´ì‹¬ë¦¬í•™ê³¼",
  "G2ë¹…ë°ì´í„°ê²½ì˜í•™ê³¼",
  "ì‹¤ìš©ìŒì•…í•™ê³¼",
  "ê°„í˜¸í•™ê³¼",
  "ì‹í’ˆì˜ì–‘í•™ê³¼",
  "ì™¸êµ­ì¸ì „ë‹´í•™ê³¼"
];

// LocalStorage í‚¤
const STORAGE_KEY = "curriculumData";

// -----------------------------
// ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
// -----------------------------
function getData() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  } catch (e) {
    console.error(e);
    return [];
  }
}

// -----------------------------
// ë°ì´í„° ì €ì¥
// -----------------------------
function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// -----------------------------
// ì—‘ì…€ ì—…ë¡œë“œ ì²˜ë¦¬
// -----------------------------
function handleUpload() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) {
    alert("ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
    return;
  }

  const reader = new FileReader();

  reader.onload = function (e) {
    const workbook = XLSX.read(e.target.result, { type: "binary" });

    // ì‹œíŠ¸ëª…ì€ "êµìœ¡ê³¼ì •"
    const sheet = workbook.Sheets["êµìœ¡ê³¼ì •"];
    if (!sheet) {
      alert("ì—‘ì…€ ì‹œíŠ¸ ì´ë¦„ì´ 'êµìœ¡ê³¼ì •'ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
      return;
    }

    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    // ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
    const meta = {
      dept: (rows[0][1] || "").toString().trim(),
      year: (rows[1][1] || "").toString().trim(),
      docNum: (rows[2][1] || "").toString().trim(),
      revDocNum: (rows[3][1] || "").toString().trim(),
      approved: (rows[4][1] || "").toString().trim() === "í™•ì •",
      meetingDate: (rows[5][1] || "").toString().trim()
    };

    if (!meta.dept || !meta.year || !meta.docNum) {
      alert("í•™ê³¼ëª…, ì…í•™ë…„ë„, ë¬¸ì„œë²ˆí˜¸ëŠ” ë°˜ë“œì‹œ ì…ë ¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.");
      return;
    }

    // êµìœ¡ê³¼ì • í…Œì´ë¸” ì‹œì‘ ìœ„ì¹˜ ì°¾ê¸°
    let startRow = -1;
    for (let i = 0; i < rows.length; i++) {
      if (rows[i][0] === "ê°œì„¤í•™ë…„") {
        startRow = i;
        break;
      }
    }
    if (startRow === -1) {
      alert("êµìœ¡ê³¼ì • í‘œì˜ í—¤ë”ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
      return;
    }

    const headers = rows[startRow];
    const dataRows = rows.slice(startRow + 1).filter(r => r.some(cell => cell !== undefined && cell !== null && cell !== ""));

    const curriculum = dataRows.map(row => {
      const obj = {};
      headers.forEach((h, i) => { obj[h] = row[i] ?? ""; });
      return obj;
    });

    let allData = getData();

    // ì´ì „ ë¬¸ì„œ ì°¾ê¸°
    let prev = null;
    if (meta.revDocNum) {
      prev = allData.find(d => d.dept === meta.dept && d.docNum === meta.revDocNum);
    }

    // ë³€ê²½ ë¹„êµ
    const changes = prev ? compareChanges(prev.data, curriculum) : null;

    const entry = {
      ...meta,
      data: curriculum,
      changes,
      uploadDate: new Date().toISOString()
    };

    allData = allData.filter(d => !(d.dept === meta.dept && d.docNum === meta.docNum));
    allData.push(entry);
    saveData(allData);

    alert("ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
    renderDeptList();
  };

  reader.readAsBinaryString(file);
}

// -----------------------------
// ë³€ê²½ ë¹„êµ ë¡œì§
// -----------------------------
function compareChanges(prevData, newData) {
  const changes = [];
  const prevMap = {};
  const newMap = {};

  prevData.forEach(item => { if (item?.["êµê³¼ëª©ëª…"]) prevMap[item["êµê³¼ëª©ëª…"]] = item; });
  newData.forEach(item => { if (item?.["êµê³¼ëª©ëª…"]) newMap[item["êµê³¼ëª©ëª…"]] = item; });

  Object.keys(newMap).forEach(name => {
    const newItem = newMap[name];
    const oldItem = prevMap[name];
    if (!oldItem) {
      changes.push({ type: "ì¶”ê°€ë¨", subject: name, before: null, after: newItem });
    } else {
      const diff = {};
      Object.keys(newItem).forEach(key => {
        if ((newItem[key] ?? "") !== (oldItem[key] ?? "")) {
          diff[key] = { before: oldItem[key] ?? "", after: newItem[key] ?? "" };
        }
      });
      if (Object.keys(diff).length > 0) {
        changes.push({ type: "ë³€ê²½ë¨", subject: name, detail: diff });
      }
    }
  });

  Object.keys(prevMap).forEach(name => {
    if (!newMap[name]) {
      changes.push({ type: "ì‚­ì œë¨", subject: name, before: prevMap[name], after: null });
    }
  });

  return changes;
}

// -----------------------------
// í•™ê³¼ ëª©ë¡ ë Œë”ë§
// -----------------------------
function renderDeptList() {
  const list = document.getElementById("deptList");
  list.innerHTML = "";

  TOP_DEPTS.forEach(dept => {
    list.innerHTML += `
      <li class="border rounded-lg px-4 py-3 hover:bg-gray-50">
        <a href="./dept/${dept}.html" class="flex items-center justify-between">
          <span class="font-semibold">${dept}</span>
          <span class="text-sm text-blue-600">ë³´ê¸°</span>
        </a>
      </li>
    `;
  });
}

renderDeptList();
</script>

</body>
</html>
