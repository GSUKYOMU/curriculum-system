<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>입학자 교육과정 관리 시스템</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React / ReactDOM / Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo } = React;

    // 엑셀 파일을 읽어서 JSON 배열로 변환
    function readExcelFile(file, callback) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          // 첫 번째 시트 기준
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
          callback(jsonData);
        } catch (error) {
          console.error(error);
          alert("엑셀 파일을 읽는 중 오류가 발생했습니다. (파일 형식 또는 내용 확인 필요)");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function App() {
      const [baseData, setBaseData] = useState([]);      // 입학자 교육과정
      const [reformData, setReformData] = useState([]);  // 개편안 / 사유서
      const [baseFileName, setBaseFileName] = useState("");
      const [reformFileName, setReformFileName] = useState("");

      // 컬럼 매핑: 어떤 헤더가 학과/입학년도/학년인지 선택
      const [columnMap, setColumnMap] = useState({
        dept: "",
        year: "",
        grade: "",
      });

      // 필터 상태
      const [filters, setFilters] = useState({
        dept: "",
        year: "",
        grade: "",
      });

      // 탭
      const [activeTab, setActiveTab] = useState("upload");

      // 입학자 교육과정 파일 업로드
      const handleBaseFileChange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setBaseFileName(file.name);
        readExcelFile(file, (rows) => {
          setBaseData(rows);
          setColumnMap({ dept: "", year: "", grade: "" });
          setFilters({ dept: "", year: "", grade: "" });
        });
      };

      // 개편안/사유서 파일 업로드
      const handleReformFileChange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setReformFileName(file.name);
        readExcelFile(file, (rows) => {
          setReformData(rows);
        });
      };

      // 입학자 교육과정 데이터의 헤더 목록
      const baseHeaders = useMemo(() => {
        if (!baseData || baseData.length === 0) return [];
        return Object.keys(baseData[0]);
      }, [baseData]);

      // 특정 컬럼 기준 고유값 목록
      const getUniqueValues = (columnKey) => {
        if (!columnKey || !baseData.length) return [];
        const set = new Set();
        baseData.forEach((row) => {
          set.add(row[columnKey]);
        });
        return Array.from(set).filter((v) => v !== "").sort();
      };

      const deptOptions = useMemo(
        () => getUniqueValues(columnMap.dept),
        [columnMap.dept, baseData]
      );
      const yearOptions = useMemo(
        () => getUniqueValues(columnMap.year),
        [columnMap.year, baseData]
      );
      const gradeOptions = useMemo(
        () => getUniqueValues(columnMap.grade),
        [columnMap.grade, baseData]
      );

      // 필터 적용된 입학자 교육과정
      const filteredCurriculum = useMemo(() => {
        if (!baseData.length) return [];
        if (!columnMap.dept || !columnMap.year || !columnMap.grade) return [];

        return baseData.filter((row) => {
          const matchDept = filters.dept ? row[columnMap.dept] === filters.dept : true;
          const matchYear = filters.year ? row[columnMap.year] === filters.year : true;
          const matchGrade = filters.grade ? row[columnMap.grade] === filters.grade : true;
          return matchDept && matchYear && matchGrade;
        });
      }, [baseData, columnMap, filters]);

      // 개편안/사유서에서 필터 적용된 데이터
      // 주의: 개편안 파일도 같은 헤더명을 쓴다고 가정 (학과/입학년도/학년)
      const filteredReform = useMemo(() => {
        if (!reformData.length) return [];
        const { dept, year, grade } = columnMap;
        if (!dept) return [];

        return reformData.filter((row) => {
          const matchDept = filters.dept
            ? row[dept] === filters.dept
            : true;
          const matchYear = filters.year && year
            ? row[year] === filters.year
            : true;
          const matchGrade = filters.grade && grade
            ? row[grade] === filters.grade
            : true;
          return matchDept && matchYear && matchGrade;
        });
      }, [reformData, columnMap, filters]);

      // 전체 요약(학과/입학년도/학년별 그룹핑) - 간단 버전
      const summaryGroups = useMemo(() => {
        if (!baseData.length) return [];
        if (!columnMap.dept || !columnMap.year || !columnMap.grade) return [];
        const map = new Map();
        baseData.forEach((row) => {
          const key = [
            row[columnMap.dept],
            row[columnMap.year],
            row[columnMap.grade],
          ].join(" | ");
          if (!map.has(key)) map.set(key, 0);
          map.set(key, map.get(key) + 1);
        });
        return Array.from(map.entries())
          .map(([key, count]) => ({ key, count }))
          .sort((a, b) => a.key.localeCompare(b.key));
      }, [baseData, columnMap]);

      return (
        <div className="max-w-6xl mx-auto py-8 px-4">
          {/* 헤더 */}
          <header className="mb-8">
            <h1 className="text-2xl md:text-3xl font-bold text-gray-800 mb-2">
              입학자 교육과정 관리 시스템
            </h1>
            <p className="text-gray-600">
              각 학과에서 제출한 입학자 교육과정 및 개편안 엑셀 파일을 업로드하여
              학과·입학년도·학년별 교육과정을 조회하고, 중간 개편 내역을 한 번에 확인할 수 있습니다.
            </p>
          </header>

          {/* 탭 */}
          <div className="mb-6 border-b border-gray-200">
            <nav className="-mb-px flex space-x-4">
              <button
                className={
                  "py-2 px-4 border-b-2 text-sm font-medium " +
                  (activeTab === "upload"
                    ? "border-indigo-500 text-indigo-600"
                    : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300")
                }
                onClick={() => setActiveTab("upload")}
              >
                1. 엑셀 업로드
              </button>
              <button
                className={
                  "py-2 px-4 border-b-2 text-sm font-medium " +
                  (activeTab === "mapping"
                    ? "border-indigo-500 text-indigo-600"
                    : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300")
                }
                onClick={() => setActiveTab("mapping")}
                disabled={!baseData.length}
              >
                2. 컬럼 매핑
              </button>
              <button
                className={
                  "py-2 px-4 border-b-2 text-sm font-medium " +
                  (activeTab === "view"
                    ? "border-indigo-500 text-indigo-600"
                    : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300")
                }
                onClick={() => setActiveTab("view")}
                disabled={!baseData.length || !columnMap.dept}
              >
                3. 학과/학년별 조회
              </button>
              <button
                className={
                  "py-2 px-4 border-b-2 text-sm font-medium " +
                  (activeTab === "summary"
                    ? "border-indigo-500 text-indigo-600"
                    : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300")
                }
                onClick={() => setActiveTab("summary")}
                disabled={!baseData.length || !columnMap.dept}
              >
                4. 전체 INDEX
              </button>
            </nav>
          </div>

          {/* 1. 업로드 탭 */}
          {activeTab === "upload" && (
            <section className="space-y-6">
              <div className="bg-white rounded-xl shadow p-4 md:p-6">
                <h2 className="text-lg font-semibold mb-4">
                  입학자 교육과정 엑셀 업로드 (필수)
                </h2>
                <p className="text-sm text-gray-600 mb-3">
                  각 학과 입학자 교육과정 취합 파일을 업로드해 주세요.
                  <br />
                  예: <strong>2023학년도 입학자교육과정 편성(안)_취합.xlsx</strong>
                </p>
                <label className="block">
                  <input
                    type="file"
                    accept=".xlsx,.xls"
                    onChange={handleBaseFileChange}
                    className="block w-full text-sm text-gray-900 file:mr-4 file:py-2 file:px-4
                      file:rounded-md file:border-0 file:text-sm file:font-semibold
                      file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
                  />
                </label>
                {baseFileName && (
                  <p className="mt-2 text-sm text-gray-700">
                    업로드된 파일: <span className="font-medium">{baseFileName}</span>{" "}
                    ({baseData.length.toLocaleString()}행)
                  </p>
                )}
              </div>

              <div className="bg-white rounded-xl shadow p-4 md:p-6">
                <h2 className="text-lg font-semibold mb-4">
                  입학자교육과정 개편안 및 사유서 엑셀 업로드 (선택)
                </h2>
                <p className="text-sm text-gray-600 mb-3">
                  학기 중 교육과정 개편(신설/폐지/명칭 변경 등)과 관련된 개편안 및 사유서 취합 파일을 업로드해 주세요.
                  <br />
                  예: <strong>입학자교육과정 개편안 및 사유서_취합.xlsx</strong>
                  <br />
                  <span className="text-xs text-gray-500">
                    ※ 학과/입학년도/학년 컬럼명은 가능하면 입학자 교육과정 파일과 동일하게 맞춰 주세요.
                  </span>
                </p>
                <label className="block">
                  <input
                    type="file"
                    accept=".xlsx,.xls"
                    onChange={handleReformFileChange}
                    className="block w-full text-sm text-gray-900 file:mr-4 file:py-2 file:px-4
                      file:rounded-md file:border-0 file:text-sm file:font-semibold
                      file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
                  />
                </label>
                {reformFileName && (
                  <p className="mt-2 text-sm text-gray-700">
                    업로드된 파일: <span className="font-medium">{reformFileName}</span>{" "}
                    ({reformData.length.toLocaleString()}행)
                  </p>
                )}
              </div>

              <div className="text-right">
                <button
                  className="inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-medium shadow hover:bg-indigo-700 disabled:bg-gray-300"
                  disabled={!baseData.length}
                  onClick={() => setActiveTab("mapping")}
                >
                  다음 단계로 (컬럼 매핑)
                </button>
              </div>
            </section>
          )}

          {/* 2. 컬럼 매핑 탭 */}
          {activeTab === "mapping" && (
            <section className="bg-white rounded-xl shadow p-4 md:p-6 space-y-6">
              <h2 className="text-lg font-semibold mb-2">
                컬럼 매핑 설정
              </h2>
              {!baseData.length ? (
                <p className="text-sm text-red-500">
                  먼저 입학자 교육과정 엑셀 파일을 업로드해 주세요.
                </p>
              ) : baseHeaders.length === 0 ? (
                <p className="text-sm text-gray-500">
                  헤더 정보를 찾을 수 없습니다. 엑셀 첫 행에 헤더(열 제목)가 있는지 확인해 주세요.
                </p>
              ) : (
                <>
                  <p className="text-sm text-gray-600">
                    업로드된 입학자 교육과정 파일의 헤더(열 이름)를 기준으로
                    <br />
                    <span className="font-medium">학과 / 입학년도 / 학년</span>에 해당하는 컬럼을 선택해 주세요.
                  </p>

                  <div className="grid md:grid-cols-3 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        학과 컬럼
                      </label>
                      <select
                        className="w-full border rounded-md px-2 py-1.5 text-sm"
                        value={columnMap.dept}
                        onChange={(e) =>
                          setColumnMap((prev) => ({ ...prev, dept: e.target.value }))
                        }
                      >
                        <option value="">선택하세요</option>
                        {baseHeaders.map((h) => (
                          <option key={h} value={h}>
                            {h}
                          </option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        입학년도 컬럼
                      </label>
                      <select
                        className="w-full border rounded-md px-2 py-1.5 text-sm"
                        value={columnMap.year}
                        onChange={(e) =>
                          setColumnMap((prev) => ({ ...prev, year: e.target.value }))
                        }
                      >
                        <option value="">선택하세요</option>
                        {baseHeaders.map((h) => (
                          <option key={h} value={h}>
                            {h}
                          </option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        학년 컬럼
                      </label>
                      <select
                        className="w-full border rounded-md px-2 py-1.5 text-sm"
                        value={columnMap.grade}
                        onChange={(e) =>
                          setColumnMap((prev) => ({ ...prev, grade: e.target.value }))
                        }
                      >
                        <option value="">선택하세요</option>
                        {baseHeaders.map((h) => (
                          <option key={h} value={h}>
                            {h}
                          </option>
                        ))}
                      </select>
                    </div>
                  </div>

                  <div className="mt-4 text-sm text-gray-500">
                    <p className="mb-1">
                      예시) 헤더가{" "}
                      <code className="bg-gray-100 px-1 rounded">
                        학과(전공)명 / 입학년도 / 학년
                      </code>
                      인 경우:
                    </p>
                    <ul className="list-disc list-inside">
                      <li>학과 컬럼 → 학과(전공)명</li>
                      <li>입학년도 컬럼 → 입학년도</li>
                      <li>학년 컬럼 → 학년</li>
                    </ul>
                  </div>

                  <div className="flex justify-between items-center mt-6">
                    <div className="text-xs text-gray-500">
                      * 컬럼 매핑을 저장하면, 이후 조회/INDEX에서 이 설정을 기준으로 필터링합니다.
                    </div>
                    <button
                      className="inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-medium shadow hover:bg-indigo-700 disabled:bg-gray-300"
                      disabled={!columnMap.dept}
                      onClick={() => setActiveTab("view")}
                    >
                      다음 단계로 (학과/학년별 조회)
                    </button>
                  </div>
                </>
              )}
            </section>
          )}

          {/* 3. 학과/학년별 조회 탭 */}
          {activeTab === "view" && (
            <section className="space-y-6">
              <div className="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                <h2 className="text-lg font-semibold mb-4">
                  학과 / 입학년도 / 학년별 교육과정 조회
                </h2>

                {!baseData.length || !columnMap.dept ? (
                  <p className="text-sm text-red-500">
                    입학자 교육과정 파일 업로드 및 컬럼 매핑을 먼저 완료해 주세요.
                  </p>
                ) : (
                  <>
                    {/* 필터 영역 */}
                    <div className="grid md:grid-cols-3 gap-4 mb-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          학과
                        </label>
                        <select
                          className="w-full border rounded-md px-2 py-1.5 text-sm"
                          value={filters.dept}
                          onChange={(e) =>
                            setFilters((prev) => ({ ...prev, dept: e.target.value }))
                          }
                        >
                          <option value="">전체</option>
                          {deptOptions.map((v) => (
                            <option key={v} value={v}>
                              {v}
                            </option>
                          ))}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          입학년도
                        </label>
                        <select
                          className="w-full border rounded-md px-2 py-1.5 text-sm"
                          value={filters.year}
                          onChange={(e) =>
                            setFilters((prev) => ({ ...prev, year: e.target.value }))
                          }
                        >
                          <option value="">전체</option>
                          {yearOptions.map((v) => (
                            <option key={v} value={v}>
                              {v}
                            </option>
                          ))}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          학년
                        </label>
                        <select
                          className="w-full border rounded-md px-2 py-1.5 text-sm"
                          value={filters.grade}
                          onChange={(e) =>
                            setFilters((prev) => ({ ...prev, grade: e.target.value }))
                          }
                        >
                          <option value="">전체</option>
                          {gradeOptions.map((v) => (
                            <option key={v} value={v}>
                              {v}
                            </option>
                          ))}
                        </select>
                      </div>
                    </div>

                    {/* 결과 요약 */}
                    <div className="mb-4 text-sm text-gray-600">
                      <span className="font-medium">입학자 교육과정</span> 결과:{" "}
                      <span className="font-semibold text-indigo-600">
                        {filteredCurriculum.length.toLocaleString()}개 교과
                      </span>
                      {filters.dept && (
                        <>
                          {" "}
                          / 학과: <span className="font-medium">{filters.dept}</span>
                        </>
                      )}
                      {filters.year && (
                        <>
                          {" "}
                          / 입학년도: <span className="font-medium">{filters.year}</span>
                        </>
                      )}
                      {filters.grade && (
                        <>
                          {" "}
                          / 학년: <span className="font-medium">{filters.grade}</span>
                        </>
                      )}
                    </div>

                    {/* 입학자 교육과정 테이블 */}
                    <div className="border rounded-lg overflow-auto mb-6">
                      <table className="min-w-full text-xs md:text-sm text-left">
                        <thead className="bg-gray-50">
                          <tr>
                            {baseHeaders.map((h) => (
                              <th
                                key={h}
                                className="px-3 py-2 font-medium text-gray-700 border-b"
                              >
                                {h}
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {filteredCurriculum.map((row, idx) => (
                            <tr
                              key={idx}
                              className={idx % 2 === 0 ? "bg-white" : "bg-gray-50"}
                            >
                              {baseHeaders.map((h) => (
                                <td
                                  key={h}
                                  className="px-3 py-1.5 border-b align-top"
                                >
                                  {row[h]}
                                </td>
                              ))}
                            </tr>
                          ))}
                          {filteredCurriculum.length === 0 && (
                            <tr>
                              <td
                                colSpan={baseHeaders.length}
                                className="px-3 py-4 text-center text-gray-500"
                              >
                                조건에 해당하는 교육과정이 없습니다.
                              </td>
                            </tr>
                          )}
                        </tbody>
                      </table>
                    </div>

                    {/* 개편/변경 내역 */}
                    <div className="mt-4">
                      <h3 className="text-md font-semibold mb-2">
                        개편·변경 내역 (업로드된 경우)
                      </h3>
                      {!reformData.length ? (
                        <p className="text-sm text-gray-500">
                          개편안/사유서 엑셀 파일이 업로드되지 않았습니다.
                        </p>
                      ) : filteredReform.length === 0 ? (
                        <p className="text-sm text-gray-500">
                          현재 선택한 조건에 해당하는 개편·변경 내역이 없습니다.
                        </p>
                      ) : (
                        <div className="border rounded-lg overflow-auto">
                          <table className="min-w-full text-xs md:text-sm text-left">
                            <thead className="bg-gray-50">
                              <tr>
                                {Object.keys(reformData[0]).map((h) => (
                                  <th
                                    key={h}
                                    className="px-3 py-2 font-medium text-gray-700 border-b"
                                  >
                                    {h}
                                  </th>
                                ))}
                              </tr>
                            </thead>
                            <tbody>
                              {filteredReform.map((row, idx) => (
                                <tr
                                  key={idx}
                                  className={idx % 2 === 0 ? "bg-white" : "bg-gray-50"}
                                >
                                  {Object.keys(reformData[0]).map((h) => (
                                    <td
                                      key={h}
                                      className="px-3 py-1.5 border-b align-top"
                                    >
                                      {row[h]}
                                    </td>
                                  ))}
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      )}
                    </div>
                  </>
                )}
              </div>
            </section>
          )}

          {/* 4. 전체 INDEX 탭 */}
          {activeTab === "summary" && (
            <section className="bg-white rounded-xl shadow p-4 md:p-6">
              <h2 className="text-lg font-semibold mb-4">
                전체 교육과정 INDEX (학과·입학년도·학년별 교과 수)
              </h2>
              {!summaryGroups.length ? (
                <p className="text-sm text-gray-500">
                  입학자 교육과정 데이터 또는 컬럼 매핑 정보가 부족합니다.
                </p>
              ) : (
                <div className="border rounded-lg overflow-hidden">
                  <table className="min-w-full text-xs md:text-sm">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-3 py-2 text-left font-medium text-gray-700 border-b">
                          학과 | 입학년도 | 학년
                        </th>
                        <th className="px-3 py-2 text-right font-medium text-gray-700 border-b">
                          교과 수
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {summaryGroups.map((item, idx) => (
                        <tr
                          key={item.key}
                          className={idx % 2 === 0 ? "bg-white" : "bg-gray-50"}
                        >
                          <td className="px-3 py-2 border-b">{item.key}</td>
                          <td className="px-3 py-2 border-b text-right">
                            {item.count.toLocaleString()}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </section>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
