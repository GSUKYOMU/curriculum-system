<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>입학자 교육과정 관리 시스템</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">

  <!-- ------------ 업로드 박스 -------------- -->
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow">
    <h1 class="text-3xl font-bold mb-6 text-center">입학자 교육과정 업로드</h1>

    <!-- 템플릿 다운로드 -->
    <div class="space-x-2 mb-4">
      <a href="./입학자교육과정 업로드 템플릿.xlsx"
         download
         class="bg-green-600 text-white px-3 py-2 rounded text-sm">
        📥 입학자교육과정 업로드 템플릿
      </a>

      <a href="./입학자교육과정_변경사유서_과목별_v5.xlsx"
         download
         class="bg-amber-500 text-white px-3 py-2 rounded text-sm">
        📥 변경사유서 템플릿(과목별)
      </a>
    </div>

    <p class="text-xs text-gray-500 mb-3">
      ※ 엑셀의 시트 이름은 <code>교육과정</code> 또는 <code>변경사유서</code> 이어야 합니다.
    </p>

    <!-- 파일 업로드 -->
    <input id="fileInput" type="file"
           accept=".xlsx,.xls"
           class="border p-3 rounded w-full mb-4"/>

    <button onclick="handleUpload()"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      업로드
    </button>
  </div>


  <!-- ------------ 학과 리스트 ------------ -->
  <div class="max-w-4xl mx-auto bg-white p-6 mt-8 rounded-xl shadow">
    <h2 class="text-2xl font-semibold mb-4">학과별 교육과정 보기</h2>
    <ul id="deptList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></ul>
  </div>


  <!-- ------------ 업로드 기록 ------------ -->
  <div class="max-w-4xl mx-auto bg-white p-6 mt-8 rounded-xl shadow">
    <h2 class="text-2xl font-semibold mb-4">업로드 기록</h2>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm border">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-2 py-1">학과</th>
            <th class="border px-2 py-1">입학년도</th>
            <th class="border px-2 py-1">문서번호</th>
            <th class="border px-2 py-1">구분</th>
            <th class="border px-2 py-1">업로드일</th>
            <th class="border px-2 py-1">삭제</th>
          </tr>
        </thead>
        <tbody id="uploadHistory"></tbody>
      </table>
    </div>

    <p class="mt-2 text-xs text-gray-500">
      * <b>교육과정 템플릿</b> 업로드 → 해당 연도의 "원본" 교육과정 저장<br>
      * <b>변경사유서</b> 업로드 → entry.data는 수정하지 않고, changes만 누적 저장(B 방식)<br>
      * 변경사유서는 삭제해도 기존 changes는 유지됨
    </p>
  </div>


<script>
/*========================================
  기본 설정
========================================*/
const STORAGE_KEY = "curriculumData";
const LOG_STORAGE_KEY = "curriculumUploadLogs";

const TOP_DEPTS = [
  "신학과",
  "사회복지학과",
  "상담심리학과",
  "G2빅데이터경영학과",
  "실용음악학과",
  "간호학과",
  "식품영양학과",
  "외국인전담학과"
];

function clean(v) {
  return (v || "")
    .toString()
    .normalize("NFKC")
    .replace(/ /g, " ")
    .trim();
}
function same(a, b) { return clean(a) === clean(b); }

function getData() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch { return []; }
}
function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function getLogs() {
  try { return JSON.parse(localStorage.getItem(LOG_STORAGE_KEY)) || []; }
  catch { return []; }
}
function saveLogs(logs) {
  localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs));
}


/*========================================
  파일 업로드 처리
========================================*/
function handleUpload() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return alert("엑셀 파일을 선택해주세요!");

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: "binary" });

    if (wb.Sheets["교육과정"]) {
      processCurriculumSheet(wb.Sheets["교육과정"]);
    } else if (wb.Sheets["변경사유서"]) {
      processChangeSheet(wb.Sheets["변경사유서"]);
    } else {
      alert("시트명이 '교육과정' 또는 '변경사유서'인지 확인하세요.");
    }
  };
  reader.readAsBinaryString(file);
}


/*========================================
  1) 교육과정 템플릿 업로드 (원본 데이터 저장)
========================================*/
function processCurriculumSheet(sh) {
  const rows = XLSX.utils.sheet_to_json(sh, { header: 1 });

  const meta = {
    dept: clean(rows[0]?.[1]),
    year: clean(rows[1]?.[1]),
    docNum: clean(rows[2]?.[1]),
    revDocNum: clean(rows[3]?.[1]),
    approved: clean(rows[4]?.[1]) === "확정",
    meetingDate: clean(rows[5]?.[1])
  };

  if (!meta.dept || !meta.year || !meta.docNum) {
    alert("학과명·입학년도·문서번호는 반드시 필요합니다.");
    return;
  }

  // 헤더 찾기
  let start = rows.findIndex(r => r[0] === "개설학년");
  if (start === -1) return alert("표 헤더(개설학년)를 찾을 수 없습니다.");

  const headers = rows[start];
const body = rows.slice(start + 1).filter(r => 
    r.some(x => clean(x) !== "")
);

  const data = body.map(r => {
    const o = {};
    headers.forEach((h,i) => o[h] = r[i] ?? "");
    return o;
  });

  let all = getData();

  // 같은 학과 + 문서번호 기존 항목 제거
  all = all.filter(e => !(e.dept === meta.dept && e.docNum === meta.docNum));

  all.push({
    ...meta,
    data,
    changes: [],
    uploadDate: new Date().toISOString()
  });

  saveData(all);

  // 로그 저장
  let logs = getLogs();
  logs.push({
    dept: meta.dept,
    year: meta.year,
    docNum: meta.docNum,
    kind: "교육과정",
    uploadDate: new Date().toISOString()
  });
  saveLogs(logs);

  alert("교육과정 업로드 완료!");
  renderUploadHistory();
  renderDeptList();
}


/*========================================
  2) 변경사유서 업로드 (B 방식)
     → 원본 데이터(entry.data)는 수정하지 않음
     → changes 배열에만 누적 저장
========================================*/
function processChangeSheet(sh) {
  const rows = XLSX.utils.sheet_to_json(sh, { header: 1 });

  const dept = clean(rows[0]?.[1]);
  const approved = clean(rows[1]?.[1]) === "확정";
  const meetingDate = clean(rows[2]?.[1]);
  const docNum = clean(rows[3]?.[1]);

  if (!dept) return alert("변경사유서의 학과명이 없습니다.");

  // 헤더 찾기
  let start = rows.findIndex(r => r[0] === "(변경할)교육과정 연도");
  if (start === -1) return alert("변경사유서 헤더를 찾을 수 없습니다.");

  const body = rows.slice(start+1).filter(r => r.some(x => x));

  let all = getData();
  let applied = 0;
  let failed = [];

  body.forEach(r => {
    const year = clean(r[0]);
    if (!year) return;

    // before
    const before = {
      grade:r[1], sem:r[2], type:r[3], name:r[4],
      credit:r[5], total:r[6], theory:r[7],
      practice:r[8], skill:r[9], experiment:r[10]
    };
    const beforeName = clean(before.name);

    // after
    const after = {
      grade:r[12], sem:r[13], type:r[14], name:r[15],
      credit:r[16], total:r[17], theory:r[18],
      practice:r[19], skill:r[20], experiment:r[21]
    };
    const afterName = clean(after.name);

    const subject = afterName || beforeName;
    if (!subject) return;

    // 해당 학과·연도 데이터 찾기
const targets = all.filter(
    e => same(e.dept, dept) && same(e.year, year)
);
    if (!targets.length) {
      failed.push(`${year}년 ${subject} — 해당 입학년도 교육과정 없음`);
      return;
    }
    targets.sort((a,b)=>new Date(b.uploadDate)-new Date(a.uploadDate));
    const entry = targets[0];

    // 원본에서 동일 과목 찾기
    const original = entry.data.find(row => same(clean(row["교과목명"]), subject));

let type;
if (!original && clean(afterName) !== "") type = "신규";
else if (original && clean(afterName) === "") type = "폐지";
else type = "변경";


    // detail 만들기
    const detail = {};
    if (type === "변경") {
      const fields = {
        "개설학년":"grade","개설학기":"sem","이수구분":"type","교과목명":"name",
        "학점":"credit","총시수":"total","이론시수":"theory",
        "실습시수":"practice","실기시수":"skill","실험시수":"experiment"
      };

      Object.keys(fields).forEach(label => {
        const key = fields[label];
        const oldVal = original[label] ?? "";
        const newVal = after[key] ?? "";
        if (!same(oldVal,newVal)) {
          detail[label] = { before: oldVal, after: newVal };
        }
      });
    }

    if (!entry.changes) entry.changes = [];

    entry.changes.push({
      year,
      type,
      subject,
      before: type==="신규" ? null : before,
      after:  type==="폐지" ? null : after,
      detail,
      reason: clean(r[11]),
      changeDocNum: docNum,
      changeDate: meetingDate || new Date().toISOString().slice(0,10)
    });

    entry.approved = approved;
    entry.meetingDate = meetingDate;

    applied++;
  });

  saveData(all);

  // 로그 저장
  let logs = getLogs();
  logs.push({
    dept,
    year: "",
    docNum: docNum || "",
    kind: "변경사유서",
    uploadDate: new Date().toISOString()
  });
  saveLogs(logs);

  alert(`변경사유서 적용 완료\n- 반영: ${applied}건\n- 미반영: ${failed.length}건`);
  renderUploadHistory();
}


/*========================================
  학과 리스트 표시
========================================*/
function renderDeptList() {
  const ul = document.getElementById("deptList");
  ul.innerHTML = "";

  TOP_DEPTS.forEach(d => {
    ul.innerHTML += `
      <li class="border rounded-lg px-4 py-3 hover:bg-gray-50">
        <a href="./dept/${d}.html" class="flex justify-between">
          <span class="font-semibold">${d}</span>
          <span class="text-blue-600 text-sm">보기</span>
        </a>
      </li>
    `;
  });
}


/*========================================
  업로드 기록 표시
========================================*/
function renderUploadHistory() {
  const logsRaw = getLogs();

  const logs = logsRaw
    .map((log,i)=>({...log,_idx:i}))
    .sort((a,b)=>new Date(b.uploadDate)-new Date(a.uploadDate));

  const tbody = document.getElementById("uploadHistory");
  tbody.innerHTML = "";

  logs.forEach(e => {
    tbody.innerHTML += `
      <tr>
        <td class="border px-2 py-1">${e.dept||""}</td>
        <td class="border px-2 py-1">${e.year||""}</td>
        <td class="border px-2 py-1">${e.docNum||""}</td>
        <td class="border px-2 py-1">${e.kind}</td>
        <td class="border px-2 py-1">${new Date(e.uploadDate).toLocaleString()}</td>
        <td class="border px-2 py-1 text-center">
          <button onclick="deleteEntry(${e._idx})"
                  class="text-red-600 text-sm">🗑</button>
        </td>
      </tr>
    `;
  });
}


/*========================================
  업로드 기록 삭제 (B 방식에서는 changes는 유지)
========================================*/
function deleteEntry(idx) {
  const logs = getLogs();
  const target = logs[idx];
  if (!target) return;

  const doDelete = confirm("해당 업로드 기록을 삭제하시겠습니까?");
  if (!doDelete) return;

  // 교육과정 템플릿 삭제 시 entry 삭제
  if (target.kind === "교육과정") {
    let all = getData();
    all = all.filter(e => !(e.dept === target.dept && same(e.year, target.year)));
    saveData(all);
  }

  logs.splice(idx,1);
  saveLogs(logs);

  renderUploadHistory();
}


/* 초기 실행 */
renderDeptList();
renderUploadHistory();
</script>

</body>
</html>
