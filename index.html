<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì…í•™ì êµìœ¡ê³¼ì • ê´€ë¦¬ ì‹œìŠ¤í…œ</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">

  <!-- ------------ ì—…ë¡œë“œ ë°•ìŠ¤ -------------- -->
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow">
    <h1 class="text-3xl font-bold mb-6 text-center">ì…í•™ì êµìœ¡ê³¼ì • ì—…ë¡œë“œ</h1>

    <!-- í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ -->
    <a href="./ì…í•™ìêµìœ¡ê³¼ì •%20ì—…ë¡œë“œ%20í…œí”Œë¦¿.xlsx"
       download="ì…í•™ìêµìœ¡ê³¼ì • ì—…ë¡œë“œ í…œí”Œë¦¿.xlsx"
       class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 inline-block mb-4">
      ğŸ“¥ ì…í•™ìêµìœ¡ê³¼ì • ì—…ë¡œë“œ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
    </a>

    <!-- íŒŒì¼ ì—…ë¡œë“œ -->
    <input id="fileInput" type="file"
           accept=".xlsx,.xls"
           class="border p-3 rounded w-full mb-4"/>

    <button onclick="handleUpload()"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      ì—…ë¡œë“œ
    </button>

    <!-- ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ -->
    <button onclick="resetStorage()"
            class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 mt-3">
      ğŸ”„ ì „ì²´ ì´ˆê¸°í™”
    </button>
  </div>


  <!-- ------------ í•™ê³¼ ë¦¬ìŠ¤íŠ¸ ------------ -->
  <div class="max-w-4xl mx-auto bg-white p-6 mt-8 rounded-xl shadow">
    <h2 class="text-2xl font-semibold mb-4">í•™ê³¼ë³„ êµìœ¡ê³¼ì • ë³´ê¸°</h2>
    <ul id="deptList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></ul>
  </div>


  <!-- ------------ ì—…ë¡œë“œ ê¸°ë¡ í…Œì´ë¸” ------------ -->
  <div class="max-w-4xl mx-auto bg-white p-6 mt-8 rounded-xl shadow">
    <h2 class="text-2xl font-semibold mb-4">ì—…ë¡œë“œ ê¸°ë¡</h2>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm border">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-2 py-1">í•™ê³¼</th>
            <th class="border px-2 py-1">ì…í•™ë…„ë„</th>
            <th class="border px-2 py-1">ë¬¸ì„œë²ˆí˜¸</th>
            <th class="border px-2 py-1">ì—…ë¡œë“œì¼</th>
            <th class="border px-2 py-1">ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="uploadHistory"></tbody>
      </table>
    </div>
  </div>



<script>
/* ---------------------------
   í•™ê³¼ ìˆœì„œ
--------------------------- */
const TOP_DEPTS = [
  "ì‹ í•™ê³¼",
  "ì‚¬íšŒë³µì§€í•™ê³¼",
  "ìƒë‹´ì‹¬ë¦¬í•™ê³¼",
  "G2ë¹…ë°ì´í„°ê²½ì˜í•™ê³¼",
  "ì‹¤ìš©ìŒì•…í•™ê³¼",
  "ê°„í˜¸í•™ê³¼",
  "ì‹í’ˆì˜ì–‘í•™ê³¼",
  "ì™¸êµ­ì¸ì „ë‹´í•™ê³¼"
];

const STORAGE_KEY = "curriculumData";


/* ---------------------------
   ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
--------------------------- */
function getData(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
  catch(e){ return []; }
}

function saveData(data){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}


/* ---------------------------
   ì—…ë¡œë“œ ì²˜ë¦¬
--------------------------- */
function handleUpload(){
  const file = document.getElementById("fileInput").files[0];
  if(!file){
    alert("ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
    return;
  }

  const reader = new FileReader();

  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: "binary" });

    const sh = wb.Sheets["êµìœ¡ê³¼ì •"];
    if(!sh){
      alert("ì‹œíŠ¸ ì´ë¦„ì´ 'êµìœ¡ê³¼ì •'ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
      return;
    }

    const rows = XLSX.utils.sheet_to_json(sh, { header: 1 });


    /* -------- ë©”íƒ€ë°ì´í„° -------- */
    const meta = {
      dept: (rows[0][1] || "").toString().trim(),
      year: (rows[1][1] || "").toString().trim(),
      docNum: (rows[2][1] || "").toString().trim(),
      revDocNum: (rows[3][1] || "").toString().trim(),
      approved: (rows[4][1] || "").toString().trim() === "í™•ì •",
      meetingDate: (rows[5][1] || "").toString().trim()
    };

    // ìˆ«ì â†’ ë¬¸ìì—´ ìë™ ë³€í™˜
    meta.year = String(meta.year).trim();

    if(!meta.dept || !meta.year || !meta.docNum){
      alert("í•™ê³¼ëª…, ì…í•™ë…„ë„, ë¬¸ì„œë²ˆí˜¸ëŠ” ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
      return;
    }


    /* -------- í‘œ ë²”ìœ„ ì°¾ê¸° -------- */
    let start = -1;
    for(let i=0; i<rows.length; i++){
      if(rows[i][0] === "ê°œì„¤í•™ë…„"){
        start = i;
        break;
      }
    }

    if(start === -1){
      alert("í‘œ í—¤ë”(ê°œì„¤í•™ë…„)ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const headers = rows[start];

    const dataRows = rows
      .slice(start + 1)
      .filter(r => r.some(c => c !== undefined && c !== null && c !== ""));

    const curriculum = dataRows.map(r => {
      const obj = {};
      headers.forEach((h, i) => obj[h] = r[i] ?? "");
      return obj;
    });


    /* -------- ë³€ê²½ë‚´ì—­ ë¹„êµ -------- */
    let all = getData();
    let prev = null;

    if(meta.revDocNum){
      prev = all.find(d => d.dept === meta.dept && d.docNum === meta.revDocNum);
    }

    const changes = prev ? compare(prev.data, curriculum) : null;


    /* -------- ì €ì¥ -------- */
    const entry = {
      ...meta,
      data: curriculum,
      changes,
      uploadDate: new Date().toISOString()
    };

    // ë™ì¼ ë¬¸ì„œë²ˆí˜¸ ì‚­ì œ í›„ ë®ì–´ì“°ê¸°
    all = all.filter(d => !(d.dept === meta.dept && d.docNum === meta.docNum));
    all.push(entry);

    saveData(all);

    alert("ì—…ë¡œë“œ ì™„ë£Œ!");
    renderDeptList();
    renderUploadHistory();
  };

  reader.readAsBinaryString(file);
}


/* ---------------------------
   ë³€ê²½ë‚´ì—­ ë¹„êµ
--------------------------- */
function compare(prev, next){
  const changes = [];
  const prevMap = {};
  const nextMap = {};

  prev.forEach(i => { if(i["êµê³¼ëª©ëª…"]) prevMap[i["êµê³¼ëª©ëª…"]] = i; });
  next.forEach(i => { if(i["êµê³¼ëª©ëª…"]) nextMap[i["êµê³¼ëª©ëª…"]] = i; });

  // ì¶”ê°€ë¨
  Object.keys(nextMap).forEach(subj => {
    if(!prevMap[subj]){
      changes.push({ type:"ì¶”ê°€ë¨", subject: subj, after: nextMap[subj] });
    } else {
      const diff = {};
      const a = nextMap[subj];
      const b = prevMap[subj];

      Object.keys(a).forEach(k => {
        if((a[k] || "") !== (b[k] || "")){
          diff[k] = { before: b[k] || "", after: a[k] || "" };
        }
      });

      if(Object.keys(diff).length > 0)
        changes.push({ type:"ë³€ê²½ë¨", subject: subj, detail: diff });
    }
  });

  // ì‚­ì œë¨
  Object.keys(prevMap).forEach(subj => {
    if(!nextMap[subj]){
      changes.push({ type:"ì‚­ì œë¨", subject: subj, before: prevMap[subj] });
    }
  });

  return changes;
}


/* ---------------------------
   í•™ê³¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
--------------------------- */
function renderDeptList(){
  const ul = document.getElementById("deptList");
  ul.innerHTML = "";

  TOP_DEPTS.forEach(d => {
    ul.innerHTML += `
      <li class="border rounded-lg px-4 py-3 hover:bg-gray-50">
        <a href="./dept/${d}.html" class="flex justify-between">
          <span class="font-semibold">${d}</span>
          <span class="text-blue-600 text-sm">ë³´ê¸°</span>
        </a>
      </li>
    `;
  });
}


/* ---------------------------
   ì—…ë¡œë“œ ê¸°ë¡ ë Œë”ë§
--------------------------- */
function renderUploadHistory(){
  const all = getData().sort((a,b) => new Date(b.uploadDate) - new Date(a.uploadDate));
  const tbody = document.getElementById("uploadHistory");

  tbody.innerHTML = "";

  all.forEach((e, idx) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td class="border px-2 py-1">${e.dept}</td>
      <td class="border px-2 py-1">${e.year}</td>
      <td class="border px-2 py-1">${e.docNum}</td>
      <td class="border px-2 py-1">${new Date(e.uploadDate).toLocaleString()}</td>
      <td class="border px-2 py-1 text-center">
        <button onclick="deleteEntry(${idx})"
                class="text-red-600 hover:text-red-800 text-sm">
          ğŸ—‘ ì‚­ì œ
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}


/* ---------------------------
   ì—…ë¡œë“œ ê¸°ë¡ ê°œë³„ ì‚­ì œ
--------------------------- */
function deleteEntry(index){
  if(confirm("í•´ë‹¹ ì—…ë¡œë“œ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
    let all = getData();
    all.splice(index, 1);
    saveData(all);
    renderUploadHistory();
  }
}


/* ---------------------------
   ì „ì²´ ì´ˆê¸°í™”
--------------------------- */
function resetStorage(){
  if(confirm("ì •ë§ ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ëª¨ë“  ì—…ë¡œë“œ ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤)")){
    localStorage.removeItem("curriculumData");
    alert("ì´ˆê¸°í™” ì™„ë£Œ! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
    location.reload();
  }
}


/* ì´ˆê¸° ì‹¤í–‰ */
renderDeptList();
renderUploadHistory();

</script>

</body>
</html>
